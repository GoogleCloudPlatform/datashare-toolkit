{
  "name": "mlb_complex",
  "projectId": "cds-ci",
  "accessControl": {
    "datasetId": "access_control",
    "viewId": "groupEntities"
  },
  "groups": [{
      "name": "newyork_users",
      "access": [{
        "userByEmail": "benjentargaryen.327201@gmail.com"
      }]
    },
    {
      "name": "chicago_users",
      "access": [{
        "userByEmail": "melisandresnow.388027@gmail.com"
      }]
    }
  ],
  "datasets": [{
      "name": "ny_fans_c",
      "groupNames": [
        "newyork_users"
      ]
    },
    {
      "name": "chicago_fans_c",
      "groupNames": [
        "chicago_users"
      ]
    }
  ],
  "views": [{
      "datasetNames": [
        "ny_fans_c"
      ],
      "name": "home_game_logs",
      "custom": {
        "query": "select game_date, v_name, v_game_number, h_name, h_game_number, sum(v_hits) as v_hits, sum(h_hits) as h_hits\nfrom `${projectId}.mlb.game_logs`\ngroup by game_date, v_name, v_game_number, h_name, h_game_number\nhaving v_hits = 0 or h_hits = 0",
        "authorizeFromDatasetIds": [
          "mlb"
        ]
      }
    },
    {
      "datasetNames": [
        "chicago_fans_c"
      ],
      "name": "away_game_logs",
      "custom": {
        "query": "select game_date, v_name, v_game_number, h_name, h_game_number, sum(v_hits) as v_hits, sum(h_hits) as h_hits\nfrom `${projectId}.mlb.game_logs`\ngroup by game_date, v_name, v_game_number, h_name, h_game_number\nhaving v_hits = 0 or h_hits = 0",
        "authorizeFromDatasetIds": [
          "mlb"
        ]
      }
    },
    {
      "datasetNames": [
        "ny_fans_c",
        "chicago_fans_c"
      ],
      "name": "aggregated_scores",
      "custom": {
        "query": "with scores as (\n  SELECT\n    h_name as team_abbrev,\n    sum(h_score) as score,\n    sum(h_game_number) as game_number,\n    count(distinct concat(cast(game_date as string), cast(h_game_number as string), h_name)) as number_of_games\n  FROM `${projectId}.mlb.game_logs`\n  group by h_name\n  union all\n  SELECT\n    v_name,\n    sum(v_score),\n    sum(v_game_number),\n    count(distinct concat(cast(game_date as string), cast(v_game_number as string), v_name))\n  FROM `${projectId}.mlb.game_logs`\n  group by v_name\n),\nteam_scores as (\n  select\n    t.team_name,\n    `from`,\n    `to`, \n    sum(s.score) as score,\n    number_of_games,\n    case when `to` - `from` = 0 then 1 else `to` - `from` end as years_active\n  from scores s\n  join `${projectId}.mlb.teams` t on s.team_abbrev = t.abbrev\n  group by t.team_name, `from`, `to`, number_of_games\n)\nselect\n  team_name,\n  `from`,\n  `to`,\n  score,\n  years_active,\n  score / years_active as avg_runs_per_year\nfrom team_scores\norder by avg_runs_per_year desc",
        "authorizeFromDatasetIds": [
          "mlb"
        ]
      }
    }
  ]
}
