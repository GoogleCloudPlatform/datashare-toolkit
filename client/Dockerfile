#
# Copyright 2019 Google LLC
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

## ---- Base Node ----

FROM golang:1.13-alpine3.11 AS base

# Set the file maintainer (your name - the file's author)
MAINTAINER Chris Page <chrispage@google.com>

# Set the application directory
WORKDIR /go/src/github.com/GoogleCloudPlatform/bq-datashare-toolkit/client

# Install Git, Go dependencies, and build the app
RUN apk --no-cache add git

#RUN cd cmd/bmc && go get -d -v
# Install outside build command for an additional image layer
RUN go get -v \
  cloud.google.com/go/pubsub \
  github.com/sirupsen/logrus \
  github.com/spf13/cobra \
  github.com/spf13/viper \
  github.com/mitchellh/go-homedir

COPY pkg                pkg
COPY internal           internal
COPY cmd                cmd

# add user in this stage because it cannot be done in next stage which is built from scratch
# in next stage we'll copy user and group information from this stage
RUN cd cmd/bmc && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o /usr/bin/bmc \
    && addgroup -S app \
    && adduser -S -g app app

# --- Release with Scratch ----
FROM scratch
USER app

COPY --from=base /etc/passwd /etc/group /etc/
COPY --from=base /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=base /usr/bin/bmc /usr/bin/
ENTRYPOINT ["/usr/bin/bmc"]
CMD ["--help"]
